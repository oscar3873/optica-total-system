{% load static %}

<div class="container mt-4">

    {% include 'core/components/messages.html' %}


    <div class="col-lg-6 col-xl-12 col-xxl-6 h-100">
        <!-- Título del formulario wizard -->
        <div class="d-flex mb-4">
            <span class="fa-stack me-2 ms-n1">
                <i class="fas fa-circle fa-stack-2x text-300"></i>
                <i class="fa-inverse fa-stack-1x text-primary fas fa-money-check"></i>
            </span>
            <div class="col">
                <h5 class="mb-0 text-primary position-relative"><span class="bg-200 dark__bg-1100 pe-3">Nueva promoción</span><span
                    class="border position-absolute top-50 translate-middle-y w-100 start-0 z-index--1"></span></h5>
                <p class="mb-0">Aquí puede crear una nueva promoción</p>
            </div>
        </div>
    </div>


    <div class="card mb-3 col-sm-10 col-lg-8">
        <!-- HEADER DE LA CARD -->
        <div class="card-header bg-light pt-3 pb-2">
            <div class="row pb-md-0">
                <div class="col-12 col-sm-6">
                    <h5 class="mb-2">Nueva promoción</h5>
                </div>
            </div>
        </div>
        <!-- BODY DE LA CARD -->
        <div class="card-body border-top">            
            <div class="row">
                <div class="col-lg-6 mb-3 mb-sm-0">
                    <div class="row">
                        <form id="#" method="post">
                            {% csrf_token %}
                            <div class="row">

                                <div class="col-12 col-md-6">
                                    <label for="{{ form.name.id_for_label }}" class="form-label">Nombre de la promoción:</label>
                                    {{form.name}}
                                    <small>El nombre de la promoción debe tener <span class="text-warning">al menos 3 caracteres.</span></small>
                                    {% if form.name.errors %}
                                    <div class="text-danger fs--2">
                                    {{form.name.errors}}
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="col-12 col-md-6 pt-3 pt-sm-0">
                                    <label for="" class="form-label">Promoción:</label>
                                    {{form.discount}}
                                    <small> <span class="text-warning"></span></small>
                                    {% if form.discount.errors %}
                                    <div class="text-danger fs--2">
                                        {{form.discount.errors}}
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="col-12 col-md-6 pt-3 pt-sm-0">
                                    <label for="" class="form-label">Fecha de inicio:</label>
                                    {{form.start_date}}
                                    <small> <span class="text-warning"></span></small>
                                    {% if form.start_date.errors %}
                                    <div class="text-danger fs--2">
                                        {{form.start_date.errors}}
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="col-12 col-md-6 pt-3 pt-sm-0">
                                    <label for="" class="form-label">Fecha de finalización:</label>
                                    {{form.end_date}}
                                    <small> <span class="text-warning"></span></small>
                                    {% if form.end_date.errors %}
                                    <div class="text-danger fs--2">
                                        {{form.end_date.errors}}
                                    </div>
                                    {% endif %}
                                </div>
                                
                            </div>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>
    
</div>



<div class="container">

    <!-- Lista de productos -->
    {% if products %}
    <div class="col-lg-12 col-xl-12 col-xxl-12 h-100">
        <!--Card-->
        <div class="card z-index-1 mb-3" id="recentPurchaseTable" data-list='{"valueNames":["user_made", "name","barcode","sale_price","description","stock","category","brand","branch"],"page":8,"pagination":true}'>
            <div class="card-header">
                <div class="row flex-between-center">
                    <div class="col-12 text-center col-sm-auto d-flex align-items-center pe-0">
                        <div>
                            <form id="searchForm" method="GET" data-ajax-search-url="{% url 'products_app:ajax_search_products' %}">
                                <div class="input-group">
                                    <input maxlength="50" class="form-control form-control-sm shadow-none search" id="searchInput" type="search" placeholder="Buscar" aria-label="search" />
                                    <div class="input-group-text bg-transparent"><span class="fa fa-search fs--1 text-600"></span></div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="col-12 text-center col-sm-auto ms-auto sm-text-end ps-0">
                        <div id="table-purchases-replace-element">
                        {% if request.user.is_staff %}
                            <a href="{% url 'products_app:new_product' %}" class="btn btn-falcon-default btn-sm me-1" type="button"><span class="fas fa-plus" data-fa-transform="shrink-3 down-2"></span><span class="d-none d-sm-inline-block ms-1">Nuevo Producto</span></a>
                            <a href="{% url 'products_app:export_list_products' %}" class="btn btn-falcon-default btn-sm ms-1" type="button"><span class="fas fa-external-link-alt" data-fa-transform="shrink-3 down-2"></span><span class="d-none d-sm-inline-block ms-1">Exportar</span></a>
                        {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body px-0 py-0">
                <div class="table-responsive scrollbar">
                    <!-- TABLA -->
                    <table class="table table-sm fs--1 mb-0 overflow-hidden">
                        <!-- HEAD TABLA -->
                        <thead class="bg-200 text-900">
                            <tr>
                                {% for column in table_column %}
                                    <th class="sort pe-1 align-middle white-space-nowrap {% if column.1 != 'Nombre' and column.1 != 'Precio' %}d-none d-md-table-cell{% endif %}" data-sort="{{column.0}}">{{column.1}}</th>
                                {% endfor %}
                                    <th class="no-sort pe-1 align-start data-table-row-action"> Acciones</th>
                            </tr>
                        </thead>
                        <!-- BODY TABLA -->
                        <tbody class="list" id="table-purchase-body">
                        
                        {% for product in products %}
                        <tr class="btn-reveal-trigger">
                            <!-- <th class="align-middle white-space-nowrap name"><a href="app/e-commerce/customer-details.html">Sylvia Plath</a></th> -->
                            <!-- <td class="align-middle white-space-nowrap email">john@gmail.com</td> -->
                            <!-- <td class="align-middle white-space-nowrap product">Slick - Drag &amp;</td> -->
                            <!-- <td class="align-middle text-center fs-0 white-space-nowrap payment"><span class="badge badge rounded-pill badge-soft-success">Success<span class="ms-1 fas fa-check" data-fa-transform="shrink-2"></span></span>
                            </td> -->
                            <!-- <td class="align-start user_made">{{product.user_made}}</td> -->
                            <td class="align-start name">{{product.name}}</td>
                            <td class="align-start d-none d-md-table-cell barcode">{{product.barcode}}</td>
                            <td class="align-start sale_price"><span class="badge badge-soft-success rounded-pill">${{product.sale_price}}</span></td>
                            <td class="align-start d-none d-md-table-cell description">{{product.description}}</td>
                            <td class="align-start d-none d-md-table-cell stock">{{product.stock}}</td>
                            <td class="align-start d-none d-md-table-cell category">{{product.category.name}}</td>
                            <td class="align-start d-none d-md-table-cell brand">{{product.brand.name}}</td>
                            <!-- <td class="align-start branch">{{product.branch.name}}</td> -->
                            <td class="align-start white-space-nowrap text-start">
                            <div class="dropstart font-sans-serif position-static d-inline-block">
                                <button class="btn btn-link text-600 btn-sm dropdown-toggle btn-reveal float-end" type="button" id="dropdown0" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true" aria-expanded="false" data-bs-reference="parent"><span class="fas fa-ellipsis-h fs--1"></span></button>
                                <div class="dropdown-menu dropdown-menu-end border py-2" aria-labelledby="dropdown0">
                                <a class="dropdown-item" href="{% url 'products_app:product_detail' product.id %}">Detalle</a>
                                
                                {% if request.user.is_staff %}
                                    <a class="dropdown-item" href="{% url 'products_app:update_product' product.id %}">Editar</a>
                                    <a class=" dropdown-item text-danger" href="{% url 'products_app:product_delete' product.id %}">Eliminar</a>
                                {% endif %}
                                    
                                </div>
                            </div>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% else %}

    <div class="col-lg-6 col-xl-12 col-xxl-6 h-100">
        <!--Card-->
        <div class="card bg-transparent-50 overflow-hidden">
            <div class="card-header position-relative">
                <div class="bg-holder d-none d-md-block bg-card z-index-1"
                    style="background-image:url(../assets/img/illustrations/ecommerce-bg.png);background-size:230px;background-position:right bottom;z-index:-1;">
                </div>

                <div class="position-relative z-index-2">
                    <div>
                        <h3 class="text-primary mb-1">No hay Productos</h3>
                    </div>
                    <div class="d-flex py-3">
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}




    <form method="post">
        {% csrf_token %}
        
        <div id="formset-forms">
            <div class="visible-form">
                <!-- Renderizar el primer formulario -->
                <script type="text/html" id="form-template">  // id="inlineformsetname-template"
                    // id='inlineformsetname-__prefix__' 
                    <tr id="form-__prefix__" class= hide_all>
                        {% for fields in form.empty_form.hidden_fields %}
                            {{ fields }}
                        {% endfor %}
                    
                        {% for fields in form.empty_form.visible_fields %}
                            <td>{{fields}}</td>
                        {% endfor %}
                    </tr>
                </script>

                {{ form }}
            </div>
        </div>
      
        <button id="add-form" type="button">Agregar más</button>
        <input type="submit" value="Guardar">
    </form>

    <div class="form-group">
        <input required type="text" id="search-products-input" class="form-control rounded p-3 box-shadow" placeholder="Buscar por Nombre, Apellido o DNI">
        <ul id="search-products-results" class="list-group text-dark mt-3"></ul>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const addFormButton = document.getElementById("add-form");
        const formsetForms = document.getElementById("formset-forms");
        
        const emptyForm = `{{ form.empty_form }}`; // Dejo aqui es script porque de esta forma toma facil los datos de la

        addFormButton.addEventListener("click", function () {
            // Clonar los formularios visibles
            const visibleForms = formsetForms.querySelectorAll(".visible-form");
            const count = visibleForms.length;
            const tmplMarkup = emptyForm.replace(/__prefix__/g, count);

            // Agregar el nuevo formulario clonado
            const newForm = document.createElement('div');
            newForm.className = 'visible-form';
            newForm.id = `id_form-${count}`;
            newForm.innerHTML = tmplMarkup;
            formsetForms.appendChild(newForm);

            if (count > 0) {
                const deleteButton = document.createElement('button');
                deleteButton.type = "button";
                deleteButton.className = "delete-form";
                deleteButton.textContent = "Eliminar";
                deleteButton.addEventListener('click', function(){
                    newForm.remove();
                    // Actualizar el contador de formularios después de la eliminación
                    const totalFormsInput = document.querySelector("#id_form-TOTAL_FORMS");
                    totalFormsInput.value = formsetForms.querySelectorAll(".visible-form").length;

                    // Reordenar los IDs y los nombres de los campos de los formularios restantes
                    formsetForms.querySelectorAll(".visible-form").forEach(function (form, index) {
                        const formId = `id_form-${index}`;
                        form.id = formId;

                        // Actualizar los nombres de los campos dentro del formulario
                        const fields = form.querySelectorAll('[name^="form-"]');
                        fields.forEach(function (field) {
                            const fieldName = field.getAttribute("name");
                            const newFieldName = fieldName.replace(/form-\d+-/, `form-${index}-`);
                            field.setAttribute("name", newFieldName);
                            
                            // Actualizar los IDs de los campos
                            const fieldId = field.getAttribute("id");
                            const newFieldId = fieldId.replace(/id_form-\d+-/, `id_form-${index}-`);
                            field.setAttribute("id", newFieldId);
                        });
                    });
                });
                newForm.appendChild(deleteButton);
            }
            // Actualizar el contador de formularios
            const totalFormsInput = document.querySelector("#id_form-TOTAL_FORMS");
            totalFormsInput.value = count + 1;
        });

    });
  </script>